{% extends "base.html" %}

{% block title %}System Configuration{% endblock %}
{% block breadcrumb_current %}Configuration{% endblock %}
{% block page_title %}System Configuration{% endblock %}
{% block page_subtitle %}Manage detection settings, camera configuration, and system preferences{% endblock %}

{% block page_actions %}
<div class="flex items-center gap-3">
	<button id="reset-config" class="btn btn-outline">
		<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<path d="M3 7v6h6"></path>
			<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
		</svg>
		Reset to Defaults
	</button>
	<button id="export-config" class="btn btn-outline">
		<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
			<polyline points="7,10 12,15 17,10"></polyline>
			<line x1="12" y1="15" x2="12" y2="3"></line>
		</svg>
		Export Config
	</button>
	<div class="flex items-center gap-2 border-l pl-3 ml-3">
		<button id="restart-app" class="btn btn-warning">
			<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M3 7v6h6"></path>
				<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
			</svg>
			Restart System
		</button>
		<button id="shutdown-app" class="btn btn-danger">
			<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
				<line x1="12" y1="2" x2="12" y2="12"></line>
			</svg>
			Shutdown
		</button>
	</div>
	<button id="save-config" class="btn btn-primary">
		<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
			<polyline points="17,21 17,13 7,13 7,21"></polyline>
			<polyline points="7,3 7,8 15,8"></polyline>
		</svg>
		Save Changes
	</button>
</div>
{% endblock %}

{% block extra_css %}
<style>
.config-section {
	margin-bottom: var(--space-8);
}

.config-form {
	display: grid;
	gap: var(--space-6);
}

.form-group {
	display: grid;
	gap: var(--space-2);
}

.form-label {
	font-weight: 600;
	color: var(--gray-900);
	display: flex;
	align-items: center;
	gap: var(--space-2);
}

.form-help {
	font-size: 0.875rem;
	color: var(--gray-600);
	margin-top: var(--space-1);
}

.form-input {
	padding: var(--space-3);
	border: 1px solid var(--border-light);
	border-radius: var(--radius);
	background: var(--surface-light);
	transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-input:focus {
	outline: none;
	border-color: var(--primary);
	box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-select {
	appearance: none;
	background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
	background-position: right 0.5rem center;
	background-repeat: no-repeat;
	background-size: 1.5em 1.5em;
	padding-right: 2.5rem;
}

.form-range {
	width: 100%;
	height: 6px;
	border-radius: 3px;
	background: var(--gray-200);
	outline: none;
	-webkit-appearance: none;
}

.form-range::-webkit-slider-thumb {
	-webkit-appearance: none;
	appearance: none;
	width: 20px;
	height: 20px;
	border-radius: 50%;
	background: var(--primary);
	cursor: pointer;
}

.form-range::-moz-range-thumb {
	width: 20px;
	height: 20px;
	border-radius: 50%;
	background: var(--primary);
	cursor: pointer;
	border: none;
}

.range-display {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-top: var(--space-2);
}

.range-value {
	font-weight: 600;
	color: var(--primary);
	background: var(--gray-100);
	padding: var(--space-1) var(--space-2);
	border-radius: var(--radius);
	min-width: 60px;
	text-align: center;
}

.checkbox-group {
	display: flex;
	align-items: center;
	gap: var(--space-3);
}

.form-checkbox {
	width: 18px;
	height: 18px;
	accent-color: var(--primary);
}

.model-selector {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	gap: var(--space-4);
	margin-top: var(--space-4);
}

.model-option {
	border: 2px solid var(--border-light);
	border-radius: var(--radius-lg);
	padding: var(--space-4);
	cursor: pointer;
	transition: all var(--transition-fast);
	text-align: center;
}

.model-option:hover {
	border-color: var(--primary);
	background: var(--gray-50);
}

.model-option.selected {
	border-color: var(--primary);
	background: var(--primary);
	color: white;
}

.model-name {
	font-weight: 600;
	margin-bottom: var(--space-2);
}

.model-description {
	font-size: 0.875rem;
	opacity: 0.8;
}

.test-button {
	margin-top: var(--space-4);
	width: 100%;
}

.status-display {
	padding: var(--space-3);
	border-radius: var(--radius);
	margin-top: var(--space-3);
	display: flex;
	align-items: center;
	gap: var(--space-2);
}

.status-success {
	background: #d1fae5;
	color: #065f46;
	border: 1px solid #6ee7b7;
}

.status-error {
	background: #fee2e2;
	color: #991b1b;
	border: 1px solid #fca5a5;
}

.status-warning {
	background: #fef3c7;
	color: #92400e;
	border: 1px solid #fcd34d;
}

.advanced-toggle {
	margin-top: var(--space-4);
	padding: var(--space-4);
	background: var(--gray-50);
	border-radius: var(--radius-lg);
	border: 1px solid var(--border-light);
}

.advanced-content {
	margin-top: var(--space-4);
	display: none;
}

.advanced-content.show {
	display: block;
}

[data-theme="dark"] .form-label {
	color: var(--gray-100);
}

[data-theme="dark"] .form-help {
	color: var(--gray-400);
}

[data-theme="dark"] .form-input {
	background: var(--surface-dark);
	border-color: var(--border-dark);
	color: var(--gray-100);
}

[data-theme="dark"] .model-option {
	border-color: var(--border-dark);
	background: var(--surface-dark);
}

[data-theme="dark"] .model-option:hover {
	background: var(--gray-800);
}

[data-theme="dark"] .range-value {
	background: var(--gray-800);
	color: var(--gray-100);
}

[data-theme="dark"] .advanced-toggle {
	background: var(--gray-800);
	border-color: var(--border-dark);
}

/* Restart and shutdown button styles */
.btn-warning {
	background: #f59e0b;
	color: white;
	border: 1px solid #f59e0b;
}

.btn-warning:hover {
	background: #d97706;
	border-color: #d97706;
}

.btn-danger {
	background: #dc2626;
	color: white;
	border: 1px solid #dc2626;
}

.btn-danger:hover {
	background: #b91c1c;
	border-color: #b91c1c;
}

.btn-warning:disabled,
.btn-danger:disabled {
	opacity: 0.6;
	cursor: not-allowed;
}

/* Confirmation modal styles */
.modal-overlay {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background: rgba(0, 0, 0, 0.5);
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 1000;
}

.modal-content {
	background: white;
	border-radius: var(--radius-lg);
	padding: var(--space-6);
	min-width: 400px;
	max-width: 500px;
	box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.modal-header {
	display: flex;
	align-items: center;
	gap: var(--space-3);
	margin-bottom: var(--space-4);
	position: relative;
}

.modal-icon {
	padding: var(--space-2);
	border-radius: 50%;
}

.modal-icon.warning {
	background: #fef3c7;
	color: #f59e0b;
}

.modal-icon.danger {
	background: #fee2e2;
	color: #dc2626;
}

.modal-title {
	font-size: 1.25rem;
	font-weight: 600;
	margin: 0;
	flex: 1;
}

.modal-close {
	position: absolute;
	top: -8px;
	right: -8px;
	background: white;
	border: 1px solid var(--border-light);
	border-radius: 50%;
	width: 32px;
	height: 32px;
	display: flex;
	align-items: center;
	justify-content: center;
	cursor: pointer;
	transition: all var(--transition-fast);
	color: var(--gray-500);
}

.modal-close:hover {
	background: var(--gray-100);
	color: var(--gray-700);
	border-color: var(--gray-300);
}

.modal-body {
	margin-bottom: var(--space-6);
}

.modal-actions {
	display: flex;
	gap: var(--space-3);
	justify-content: flex-end;
}

[data-theme="dark"] .modal-content {
	background: var(--surface-dark);
	color: var(--gray-100);
}

[data-theme="dark"] .modal-close {
	background: var(--surface-dark);
	border-color: var(--border-dark);
	color: var(--gray-400);
}

[data-theme="dark"] .modal-close:hover {
	background: var(--gray-800);
	color: var(--gray-200);
	border-color: var(--gray-600);
}

/* Loading spinner animation */
@keyframes spin {
	0% { transform: rotate(0deg); }
	100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<form id="config-form" class="config-form">
	<!-- Detection Settings -->
	<div class="config-section">
		<div class="card">
			<div class="card-header">
				<h3 class="card-title">Detection Settings</h3>
				<p class="card-subtitle">Configure license plate detection parameters</p>
			</div>
			<div class="card-body">
				<div class="grid grid-cols-2 gap-6">
					<!-- Confidence Threshold -->
					<div class="form-group">
						<label class="form-label">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M9 12l2 2 4-4"/>
								<path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
								<path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
							</svg>
							Confidence Threshold
						</label>
						<input type="range" id="confidence-threshold" class="form-range" min="0.1" max="1.0" step="0.05" value="0.5">
						<div class="range-display">
							<span class="form-help">Lower values detect more plates but may include false positives</span>
							<span class="range-value" id="confidence-value">0.5</span>
						</div>
					</div>

					<!-- Model Selection -->
					<div class="form-group">
						<label class="form-label">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
								<line x1="8" y1="21" x2="16" y2="21"/>
								<line x1="12" y1="17" x2="12" y2="21"/>
							</svg>
							YOLO Model
						</label>
						<select id="model-selection" class="form-input form-select">
							<option value="app/models/yolo11m_best.pt">YOLO11M Best (Recommended)</option>
							<option value="app/models/yolo11n.pt">YOLO11N (Fast)</option>
							<option value="app/models/yolov8m.pt">YOLOv8M (Stable)</option>
							<option value="app/models/yolov8n.pt">YOLOv8N (Lightweight)</option>
						</select>
						<div class="form-help">Choose the YOLO model based on your hardware capabilities</div>
						
						<button type="button" id="test-model" class="btn btn-outline test-button">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
							</svg>
							Test Model Performance
						</button>
					</div>
				</div>

				<!-- Processing Settings -->
				<div class="grid grid-cols-3 gap-6 mt-6">
					<div class="form-group">
						<label class="form-label">Processing Frequency</label>
						<select id="processing-frequency" class="form-input form-select">
							<option value="1">Every Frame</option>
							<option value="3" selected>Every 3rd Frame</option>
							<option value="5">Every 5th Frame</option>
							<option value="10">Every 10th Frame</option>
						</select>
						<div class="form-help">Higher values reduce CPU usage</div>
					</div>

					<div class="form-group">
						<label class="form-label">Detection Timeout</label>
						<input type="number" id="detection-timeout" class="form-input" value="5" min="1" max="30">
						<div class="form-help">Seconds before detection timeout</div>
					</div>

					<div class="form-group">
						<label class="form-label">Max Detections</label>
						<input type="number" id="max-detections" class="form-input" value="10" min="1" max="100">
						<div class="form-help">Maximum detections per frame</div>
					</div>
				</div>

				<!-- Enhancement Options -->
				<div class="grid grid-cols-2 gap-6 mt-6">
					<div class="form-group">
						<div class="checkbox-group">
							<input type="checkbox" id="auto-enhance" class="form-checkbox" checked>
							<label for="auto-enhance" class="form-label">Auto-enhance detected plates</label>
						</div>
						<div class="form-help">Automatically enhance detected license plate images</div>
					</div>

					<div class="form-group">
						<div class="checkbox-group">
							<input type="checkbox" id="save-detections" class="form-checkbox" checked>
							<label for="save-detections" class="form-label">Save detection images</label>
						</div>
						<div class="form-help">Store images of detected license plates</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Camera Settings -->
	<div class="config-section">
		<div class="card">
			<div class="card-header">
				<h3 class="card-title">Camera Configuration</h3>
				<p class="card-subtitle">Configure camera source and video settings</p>
			</div>
			<div class="card-body">
				<div class="grid grid-cols-2 gap-6">
					<!-- Camera Source -->
					<div class="form-group">
						<label class="form-label">
							<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="m23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
								<circle cx="12" cy="13" r="4"/>
							</svg>
							Camera Source
						</label>
						<div class="flex gap-2 items-end">
							<div class="flex-1">
								<select id="camera-source" class="form-input form-select">
									<option value="">Loading cameras...</option>
								</select>
							</div>
							<button id="refresh-cameras" class="btn btn-outline" type="button" title="Refresh camera list">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M3 7v6h6"></path>
									<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
								</svg>
								Refresh
							</button>
						</div>
						<div id="camera-info" class="form-help">Select your camera input source</div>
					</div>

					<!-- IP Camera URL (conditional) -->
					<div class="form-group" id="ip-camera-group" style="display: none;">
						<label class="form-label">IP Camera URL</label>
						<input type="url" id="ip-camera-url" class="form-input" placeholder="http://192.168.1.100:8080/video">
						<div class="form-help">Enter the IP camera stream URL</div>
					</div>

					<!-- Resolution -->
					<div class="form-group">
						<label class="form-label">Resolution</label>
						<select id="camera-resolution" class="form-input form-select">
							<option value="640x480">640x480 (VGA)</option>
							<option value="1280x720" selected>1280x720 (HD)</option>
							<option value="1920x1080">1920x1080 (Full HD)</option>
							<option value="custom">Custom</option>
						</select>
						<div class="form-help">Higher resolutions require more processing power</div>
					</div>

					<!-- Custom Resolution (conditional) -->
					<div class="form-group" id="custom-resolution-group" style="display: none;">
						<label class="form-label">Custom Resolution</label>
						<div class="flex gap-2">
							<input type="number" id="custom-width" class="form-input" placeholder="Width" min="320" max="3840">
							<span class="flex items-center">×</span>
							<input type="number" id="custom-height" class="form-input" placeholder="Height" min="240" max="2160">
						</div>
					</div>

					<!-- Frame Rate -->
					<div class="form-group">
						<label class="form-label">Frame Rate (FPS)</label>
						<input type="range" id="frame-rate" class="form-range" min="5" max="60" step="5" value="30">
						<div class="range-display">
							<span class="form-help">Frames per second</span>
							<span class="range-value" id="fps-value">30</span>
						</div>
					</div>

					<!-- Buffer Size -->
					<div class="form-group">
						<label class="form-label">Buffer Size</label>
						<input type="number" id="buffer-size" class="form-input" value="1" min="1" max="10">
						<div class="form-help">Number of frames to buffer (1 = no buffering)</div>
					</div>
				</div>

				<!-- Camera Test -->
				<div class="mt-6">
					<button type="button" id="test-camera" class="btn btn-secondary">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<circle cx="12" cy="12" r="10"/>
							<polygon points="10,8 16,12 10,16 10,8"/>
						</svg>
						Test Camera Connection
					</button>
					<div id="camera-status" class="status-display status-success" style="display: none;">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
							<path d="M9 12l2 2 4-4"/>
						</svg>
						Camera connection successful
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Storage & Backup Settings -->
	<div class="config-section">
		<div class="card">
			<div class="card-header">
				<h3 class="card-title">Storage & Backup</h3>
				<p class="card-subtitle">Manage data storage and backup preferences</p>
			</div>
			<div class="card-body">
				<div class="grid grid-cols-3 gap-6">
					<div class="form-group">
						<label class="form-label">Max Detections to Store</label>
						<input type="number" id="max-stored-detections" class="form-input" value="10000" min="100">
						<div class="form-help">Older detections will be automatically cleaned up</div>
					</div>

					<div class="form-group">
						<label class="form-label">Cleanup After (Days)</label>
						<input type="number" id="cleanup-days" class="form-input" value="30" min="1" max="365">
						<div class="form-help">Delete detection data older than this</div>
					</div>

					<div class="form-group">
						<label class="form-label">Backup Frequency</label>
						<select id="backup-frequency" class="form-input form-select">
							<option value="never">Never</option>
							<option value="daily" selected>Daily</option>
							<option value="weekly">Weekly</option>
							<option value="monthly">Monthly</option>
						</select>
					</div>
				</div>

				<div class="grid grid-cols-2 gap-6 mt-6">
					<div class="form-group">
						<div class="checkbox-group">
							<input type="checkbox" id="compress-images" class="form-checkbox" checked>
							<label for="compress-images" class="form-label">Compress saved images</label>
						</div>
						<div class="form-help">Reduce storage space by compressing detection images</div>
					</div>

					<div class="form-group">
						<div class="checkbox-group">
							<input type="checkbox" id="export-csv" class="form-checkbox">
							<label for="export-csv" class="form-label">Auto-export daily CSV</label>
						</div>
						<div class="form-help">Automatically export daily detection reports</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Advanced Settings -->
	<div class="config-section">
		<div class="card">
			<div class="card-header">
				<div class="flex items-center justify-between">
					<div>
						<h3 class="card-title">Advanced Settings</h3>
						<p class="card-subtitle">Expert configuration options</p>
					</div>
					<button type="button" id="toggle-advanced" class="btn btn-outline">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<polyline points="6,9 12,15 18,9"/>
						</svg>
						Show Advanced
					</button>
				</div>
			</div>
			<div class="card-body">
				<div id="advanced-content" class="advanced-content">
					<div class="grid grid-cols-2 gap-6">
						<div class="form-group">
							<label class="form-label">GPU Device ID</label>
							<input type="number" id="gpu-device" class="form-input" value="0" min="0">
							<div class="form-help">CUDA device ID for GPU acceleration</div>
						</div>

						<div class="form-group">
							<label class="form-label">Worker Threads</label>
							<input type="number" id="worker-threads" class="form-input" value="4" min="1" max="16">
							<div class="form-help">Number of processing threads</div>
						</div>

						<div class="form-group">
							<label class="form-label">API Rate Limit</label>
							<input type="number" id="rate-limit" class="form-input" value="100" min="10">
							<div class="form-help">Requests per minute limit</div>
						</div>

						<div class="form-group">
							<label class="form-label">Log Level</label>
							<select id="log-level" class="form-input form-select">
								<option value="DEBUG">Debug</option>
								<option value="INFO" selected>Info</option>
								<option value="WARNING">Warning</option>
								<option value="ERROR">Error</option>
							</select>
						</div>
					</div>

					<div class="grid grid-cols-1 gap-6 mt-6">
						<div class="form-group">
							<div class="checkbox-group">
								<input type="checkbox" id="debug-mode" class="form-checkbox">
								<label for="debug-mode" class="form-label">Enable debug mode</label>
							</div>
							<div class="form-help">Enable detailed logging and debugging features</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</form>
{% endblock %}

{% block page_js %}
// System Configuration Page JavaScript
class SystemConfig {
	constructor() {
		this.config = {};
		this.hasChanges = false;
		this.init();
	}

	async init() {
		this.setupEventListeners();
		await this.loadCurrentConfig(); // Load config first
	}

	setupEventListeners() {
		// Save, export, and reset buttons
		document.getElementById('save-config')?.addEventListener('click', () => this.saveConfig());
		document.getElementById('export-config')?.addEventListener('click', () => this.exportConfig());
		document.getElementById('reset-config')?.addEventListener('click', () => this.resetConfig());
		
		// Restart and shutdown buttons
		document.getElementById('restart-app')?.addEventListener('click', () => this.confirmRestart());
		document.getElementById('shutdown-app')?.addEventListener('click', () => this.confirmShutdown());
		
		// Range sliders
		document.getElementById('confidence-threshold')?.addEventListener('input', (e) => {
			document.getElementById('confidence-value').textContent = parseFloat(e.target.value).toFixed(2);
			this.markChanged();
		});
		
		document.getElementById('frame-rate')?.addEventListener('input', (e) => {
			document.getElementById('fps-value').textContent = e.target.value;
			this.markChanged();
		});
		
		// Camera source changes
		document.getElementById('camera-source')?.addEventListener('change', (e) => {
			try {
				const selectedValue = e.target.value;
				console.log(`Camera source changed to: ${selectedValue}`);
				this.handleCameraSourceChange(selectedValue);
				this.markChanged();
			} catch (error) {
				console.error('Error handling camera source change:', error);
			}
		});
		
		// Resolution changes
		document.getElementById('camera-resolution')?.addEventListener('change', (e) => {
			this.handleResolutionChange(e.target.value);
			this.markChanged();
		});
		
		// Test buttons
		document.getElementById('test-camera')?.addEventListener('click', () => this.testCamera());
		document.getElementById('test-model')?.addEventListener('click', () => this.testModel());
		
		// Camera refresh button
		document.getElementById('refresh-cameras')?.addEventListener('click', () => this.refreshCameras());
		
		// Advanced toggle
		document.getElementById('toggle-advanced')?.addEventListener('click', () => this.toggleAdvanced());
		
		// Mark changes on all form inputs
		const form = document.getElementById('config-form');
		if (form) {
			form.addEventListener('change', () => this.markChanged());
		}
		
		// Warn before leaving with unsaved changes
		window.addEventListener('beforeunload', (e) => {
			if (this.hasChanges) {
				e.preventDefault();
				e.returnValue = '';
			}
		});
	}

	async loadAvailableCameras() {
		try {
			const response = await fetch('/api/system/cameras');
			if (!response.ok) {
				throw new Error('Failed to fetch available cameras');
			}
			
			const data = await response.json();
			const cameras = data.cameras || [];
			
			// Update camera source select options
			const cameraSelect = document.getElementById('camera-source');
			if (cameraSelect && cameras.length > 0) {
				// Clear existing options except IP and file options
				cameraSelect.innerHTML = '';
				
				// Add detected cameras
				cameras.forEach(camera => {
					const option = document.createElement('option');
					option.value = camera.id;
					
					if (camera.type === 'usb') {
						option.textContent = `${camera.name} (${camera.resolution})`;
						if (!camera.is_working) {
							option.textContent += ' - Not Available';
							option.disabled = true;
						}
					} else if (camera.type === 'ip') {
						option.textContent = 'IP Camera (RTSP/HTTP)';
					} else if (camera.type === 'file') {
						option.textContent = 'Video File';
					}
					
					cameraSelect.appendChild(option);
				});
				
				console.log(`Loaded ${cameras.length} camera options`);
				
				// Store cameras for reference
				this.availableCameras = cameras;
			}
		} catch (error) {
			console.error('Error loading available cameras:', error);
			
			// Fallback to minimal options if API fails
			const cameraSelect = document.getElementById('camera-source');
			if (cameraSelect) {
				cameraSelect.innerHTML = `
					<option value="">Failed to load cameras</option>
					<option value="0">Camera 0 (Fallback)</option>
					<option value="ip">IP Camera</option>
				`;
			}
		}
	}

	async loadCurrentConfig() {
		try {
			const response = await fetch('/api/system/config');
			if (response.ok) {
				this.config = await response.json();
				await this.populateForm();
			}
		} catch (error) {
			console.error('Error loading config:', error);
			await this.loadDefaultConfig();
		}
	}

	async loadAvailableCameras(forceRefresh = false) {
		try {
			this.updateCameraInfo('Loading cameras...');
			
			const url = forceRefresh 
				? '/api/system/cameras?force_refresh=true'
				: '/api/system/cameras';
			
			const response = await fetch(url);
			if (response.ok) {
				const result = await response.json();
				this.populateCameraDropdown(result);
				this.updateCameraInfo(result);
			}
		} catch (error) {
			console.error('Error loading available cameras:', error);
			this.updateCameraInfo('Failed to load cameras');
		}
	}

	async refreshCameras() {
		const button = document.getElementById('refresh-cameras');
		if (button) {
			button.disabled = true;
			button.innerHTML = `
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin">
					<path d="M3 7v6h6"></path>
					<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
				</svg>
				Scanning...
			`;
		}
		
		try {
			console.log('Manual camera refresh triggered');
			this.updateCameraInfo('Scanning for cameras...');
			
			const response = await fetch('/api/system/cameras/refresh', {
				method: 'POST'
			});
			
			if (response.ok) {
				const result = await response.json();
				this.populateCameraDropdown(result);
				this.updateCameraInfo(result);
				console.log('Camera refresh completed');
			} else {
				throw new Error('Camera refresh failed');
			}
		} catch (error) {
			console.error('Camera refresh error:', error);
			this.updateCameraInfo('Camera refresh failed');
		} finally {
			if (button) {
				button.disabled = false;
				button.innerHTML = `
					<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M3 7v6h6"></path>
						<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
					</svg>
					Refresh
				`;
			}
		}
	}

	updateCameraInfo(result) {
		const infoElement = document.getElementById('camera-info');
		if (!infoElement) return;
		
		if (typeof result === 'string') {
			infoElement.textContent = result;
			return;
		}
		
		// Display cache info and camera count
		const cacheInfo = result.cache_info || {};
		const count = result.count || 0;
		const cached = result.cached || false;
		
		let infoText = `${count} camera(s) found`;
		
		if (cached) {
			const ageSeconds = cacheInfo.age_seconds || 0;
			const ageText = ageSeconds < 60 
				? `${ageSeconds}s ago`
				: `${Math.floor(ageSeconds / 60)}m ago`;
			infoText += ` (cached ${ageText})`;
		} else {
			infoText += ' (fresh scan)';
		}
		
		if (result.scan_duration) {
			infoText += ` • Scan took ${result.scan_duration.toFixed(1)}s`;
		}
		
		infoElement.textContent = infoText;
	}

	populateCameraDropdown(result) {
		const select = document.getElementById('camera-source');
		if (!select) return;

		// Store current selection before clearing
		const currentValue = select.value;

		// Clear existing options
		select.innerHTML = '';

		// Handle both old and new result formats
		const cameras = result.cameras || result;
		const usbCameras = cameras.filter(c => c.type === 'usb' && c.is_working);
		
		if (usbCameras.length === 0) {
			const noOption = document.createElement('option');
			noOption.value = '';
			noOption.textContent = 'No working cameras detected';
			noOption.disabled = true;
			select.appendChild(noOption);
		}

		for (const camera of usbCameras) {
			const option = document.createElement('option');
			option.value = camera.id;
			
			// Build descriptive name
			let displayName = camera.name || camera.description;
			
			// Add duplicate indicator if detected
			if (camera.is_duplicate) {
				displayName += ` [DUPLICATE]`;
				option.style.color = '#f59e0b'; // Orange color for duplicates
				option.style.fontStyle = 'italic';
			}

			option.textContent = displayName;
			select.appendChild(option);
		}

		// Add IP camera option
		const ipOption = document.createElement('option');
		ipOption.value = 'ip';
		ipOption.textContent = 'IP Camera (RTSP/HTTP)';
		select.appendChild(ipOption);

		// Add file option  
		const fileOption = document.createElement('option');
		fileOption.value = 'file';
		fileOption.textContent = 'Video File';
		select.appendChild(fileOption);

		// Restore previous selection if it still exists
		if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
			select.value = currentValue;
		}

		console.log(`Populated camera dropdown with ${usbCameras.length} working cameras`);
	}

	async loadDefaultConfig() {
		// Load default configuration
		this.config = {
			detection: {
				confidence_threshold: 0.5,
				model_path: "app/models/yolo11m_best.pt",
				enhancement_enabled: true,
				save_detections: true,
				processing_frequency: 3,
				detection_timeout: 5,
				max_detections: 10
			},
			camera: {
				source: "0",
				width: 1280,
				height: 720,
				fps: 30,
				buffer_size: 1
			},
			storage: {
				max_detections: 10000,
				cleanup_days: 30,
				backup_frequency: "daily",
				compress_images: true,
				export_csv: false
			},
			advanced: {
				gpu_device: 0,
				worker_threads: 4,
				rate_limit: 100,
				log_level: "INFO",
				debug_mode: false
			}
		};
		await this.populateForm();
	}

	async populateForm() {
		const config = this.config;
		
		console.log('Populating form with config:', config);
		
		// Load available cameras first
		await this.loadAvailableCameras();
		
		// Detection settings
		if (config.detection) {
			this.setFormValue('confidence-threshold', config.detection.confidence_threshold);
			this.setFormValue('model-selection', config.detection.model_path);
			this.setFormValue('auto-enhance', config.detection.enhancement_enabled);
			this.setFormValue('save-detections', config.detection.save_detections);
			this.setFormValue('processing-frequency', config.detection.processing_frequency);
			this.setFormValue('detection-timeout', config.detection.detection_timeout);
			this.setFormValue('max-detections', config.detection.max_detections);
		}
		
		// Camera settings
		if (config.camera) {
			this.setFormValue('camera-source', config.camera.source || config.camera.camera_source);
			
			// Handle resolution - check multiple possible field names
			const width = config.camera.width || config.camera.camera_width || 1280;
			const height = config.camera.height || config.camera.camera_height || 720;
			this.setFormValue('camera-resolution', `${width}x${height}`);
			
			// Handle FPS - check multiple possible field names
			const fps = config.camera.fps || config.camera.camera_fps || 30;
			this.setFormValue('frame-rate', fps);
			
			this.setFormValue('buffer-size', config.camera.buffer_size);
			
			// Handle IP camera URL if present
			if (config.camera.ip_url || config.camera.ip_camera_url) {
				this.setFormValue('ip-camera-url', config.camera.ip_url || config.camera.ip_camera_url);
			}
		}
		
		// Storage settings
		if (config.storage) {
			this.setFormValue('max-stored-detections', config.storage.max_detections || config.storage.max_stored_detections);
			this.setFormValue('cleanup-days', config.storage.cleanup_days);
			this.setFormValue('backup-frequency', config.storage.backup_frequency);
			this.setFormValue('compress-images', config.storage.compress_images);
			this.setFormValue('export-csv', config.storage.export_csv);
		}
		
		// Processing settings (if available)
		if (config.processing) {
			// These would be handled in a more advanced settings section
			console.log('Processing settings available:', config.processing);
		}
		
		// Advanced settings
		if (config.advanced) {
			this.setFormValue('gpu-device', config.advanced.gpu_device || 0);
			this.setFormValue('worker-threads', config.advanced.worker_threads);
			this.setFormValue('rate-limit', config.advanced.rate_limit);
			this.setFormValue('log-level', config.advanced.log_level);
			this.setFormValue('debug-mode', config.advanced.debug_mode);
		}
		
		// Update range displays
		this.updateRangeDisplays();
		
		// Update camera source visibility
		const cameraSource = config.camera?.source || config.camera?.camera_source || '0';
		this.handleCameraSourceChange(cameraSource);
		
		// Update resolution visibility
		const width = config.camera?.width || config.camera?.camera_width || 1280;
		const height = config.camera?.height || config.camera?.camera_height || 720;
		const resolution = `${width}x${height}`;
		this.handleResolutionChange(resolution);
		
		console.log('Form populated successfully');
	}

	setFormValue(id, value) {
		const element = document.getElementById(id);
		if (!element) {
			console.warn(`Element with id '${id}' not found`);
			return;
		}
		
		if (value === undefined || value === null) {
			console.debug(`Skipping ${id} - value is ${value}`);
			return;
		}
		
		if (element.type === 'checkbox') {
			element.checked = Boolean(value);
		} else {
			element.value = String(value);
		}
		
		console.debug(`Set ${id} = ${value} (type: ${element.type})`);
	}

	updateRangeDisplays() {
		const confidenceSlider = document.getElementById('confidence-threshold');
		const confidenceValue = document.getElementById('confidence-value');
		if (confidenceSlider && confidenceValue) {
			confidenceValue.textContent = parseFloat(confidenceSlider.value).toFixed(2);
		}
		
		const fpsSlider = document.getElementById('frame-rate');
		const fpsValue = document.getElementById('fps-value');
		if (fpsSlider && fpsValue) {
			fpsValue.textContent = fpsSlider.value;
		}
	}

	handleCameraSourceChange(source) {
		console.log(`Handling camera source change to: ${source}`);
		
		// Show/hide IP camera URL input
		const ipGroup = document.getElementById('ip-camera-group');
		if (ipGroup) {
			const shouldShow = source === 'ip';
			ipGroup.style.display = shouldShow ? 'block' : 'none';
			console.log(`IP camera group ${shouldShow ? 'shown' : 'hidden'}`);
		}
		
		// Update camera status display if available
		const statusElement = document.getElementById('camera-status');
		if (statusElement && source !== 'ip' && source !== 'file' && source !== '') {
			statusElement.style.display = 'none'; // Clear previous status
		}
	}

	handleResolutionChange(resolution) {
		const customGroup = document.getElementById('custom-resolution-group');
		if (customGroup) {
			customGroup.style.display = resolution === 'custom' ? 'block' : 'none';
		}
	}

	async testCamera() {
		const button = document.getElementById('test-camera');
		const status = document.getElementById('camera-status');
		const cameraSource = document.getElementById('camera-source').value;
		
		if (button) {
			button.disabled = true;
			button.textContent = 'Testing...';
		}
		
		try {
			// Call actual camera test API
			const response = await fetch(`/api/system/cameras/test?source=${encodeURIComponent(cameraSource)}`, {
				method: 'GET'
			});
			
			const result = await response.json();
			
			if (response.ok && result.success) {
				if (status) {
					status.className = 'status-display status-success';
					status.innerHTML = `
						<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
							<path d="M9 12l2 2 4-4"/>
						</svg>
						Camera connection successful (${result.resolution || 'Unknown resolution'})
					`;
					status.style.display = 'flex';
				}
				
				if (window.lprApp) {
					window.lprApp.showNotification('Camera test successful', 'success');
				}
			} else {
				throw new Error(result.message || 'Camera test failed');
			}
		} catch (error) {
			console.error('Camera test error:', error);
			
			if (status) {
				status.className = 'status-display status-error';
				status.innerHTML = `
					<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
						<path d="M6 18L18 6M6 6l12 12"/>
					</svg>
					Camera connection failed: ${error.message}
				`;
				status.style.display = 'flex';
			}
			
			if (window.lprApp) {
				window.lprApp.showNotification('Camera test failed: ' + error.message, 'danger');
			}
		} finally {
			if (button) {
				button.disabled = false;
				button.innerHTML = `
					<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="12" cy="12" r="10"/>
						<polygon points="10,8 16,12 10,16 10,8"/>
					</svg>
					Test Camera Connection
				`;
			}
		}
	}

	async testModel() {
		const button = document.getElementById('test-model');
		
		if (button) {
			button.disabled = true;
			button.textContent = 'Testing Model...';
		}
		
		try {
			// Simulate model test
			await new Promise(resolve => setTimeout(resolve, 3000));
			
			if (window.lprApp) {
				window.lprApp.showNotification('Model test completed successfully', 'success');
			}
		} catch (error) {
			if (window.lprApp) {
				window.lprApp.showNotification('Model test failed', 'danger');
			}
		} finally {
			if (button) {
				button.disabled = false;
				button.innerHTML = `
					<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
					</svg>
					Test Model Performance
				`;
			}
		}
	}

	toggleAdvanced() {
		const content = document.getElementById('advanced-content');
		const button = document.getElementById('toggle-advanced');
		
		if (content && button) {
			const isShown = content.classList.toggle('show');
			button.textContent = isShown ? 'Hide Advanced' : 'Show Advanced';
		}
	}

	async saveConfig() {
		try {
			const formData = this.collectFormData();
			
			console.log('Saving configuration with data:', formData);
			console.log('Form data keys:', Object.keys(formData));
			console.log('Processing frequency value:', formData.processing_frequency);
			console.log('Detection timeout value:', formData.detection_timeout);
			console.log('Max detections value:', formData.max_detections);
			console.log('Camera FPS value:', formData.camera_fps);
			
			const response = await fetch('/api/system/config', {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(formData)
			});
			
			const result = await response.json();
			
			if (response.ok) {
				this.hasChanges = false;
				
				let message = result.message || 'Configuration saved successfully';
				if (result.restart_required) {
					message += '. Some changes require application restart to take effect.';
				}
				
				if (window.lprApp) {
					window.lprApp.showNotification(message, 'success');
				}
				
				console.log('Configuration saved successfully:', result);
				
				// Reload config to verify it was saved
				await this.loadCurrentConfig();
			} else {
				throw new Error(result.detail || result.message || 'Failed to save configuration');
			}
		} catch (error) {
			console.error('Error saving config:', error);
			if (window.lprApp) {
				window.lprApp.showNotification('Failed to save configuration: ' + error.message, 'danger');
			}
		}
	}

	async restartStream() {
		try {
			// Call the stream restart endpoint
			const response = await fetch('/api/system/restart', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ component: 'camera' })
			});
			
			if (response.ok) {
				console.log('Stream restart requested');
			} else {
				console.warn('Failed to restart stream');
			}
		} catch (error) {
			console.error('Error restarting stream:', error);
		}
	}

	collectFormData() {
		const resolution = document.getElementById('camera-resolution').value;
		let width = 1280, height = 720;
		
		if (resolution === 'custom') {
			width = parseInt(document.getElementById('custom-width').value) || 1280;
			height = parseInt(document.getElementById('custom-height').value) || 720;
		} else if (resolution !== 'custom') {
			[width, height] = resolution.split('x').map(Number);
		}
		
		// Get form elements and log if they exist
		const processingFreqElement = document.getElementById('processing-frequency');
		const detectionTimeoutElement = document.getElementById('detection-timeout');
		const maxDetectionsElement = document.getElementById('max-detections');
		const frameRateElement = document.getElementById('frame-rate');
		
		console.debug('Form elements found:', {
			'processing-frequency': !!processingFreqElement,
			'detection-timeout': !!detectionTimeoutElement,
			'max-detections': !!maxDetectionsElement,
			'frame-rate': !!frameRateElement
		});
		
		if (processingFreqElement) {
			console.debug('Processing frequency element value:', processingFreqElement.value, 'selected index:', processingFreqElement.selectedIndex);
		}
		
		// Collect all form data in the new API format
		const formData = {
			// Detection settings
			confidence_threshold: parseFloat(document.getElementById('confidence-threshold').value),
			model_path: document.getElementById('model-selection').value,
			enhancement_enabled: document.getElementById('auto-enhance').checked,
			save_detections: document.getElementById('save-detections').checked,
			processing_frequency: processingFreqElement ? parseInt(processingFreqElement.value) : 3,
			detection_timeout: detectionTimeoutElement ? parseInt(detectionTimeoutElement.value) : 5,
			max_detections: maxDetectionsElement ? parseInt(maxDetectionsElement.value) : 10,
			
			// Camera settings
			camera_source: document.getElementById('camera-source').value,
			camera_width: width,
			camera_height: height,
			camera_fps: frameRateElement ? parseInt(frameRateElement.value) : 30,
			buffer_size: parseInt(document.getElementById('buffer-size').value),
			ip_camera_url: document.getElementById('ip-camera-url')?.value || null,
			
			// Storage settings
			max_stored_detections: parseInt(document.getElementById('max-stored-detections').value),
			cleanup_days: parseInt(document.getElementById('cleanup-days').value),
			backup_frequency: document.getElementById('backup-frequency').value,
			compress_images: document.getElementById('compress-images').checked,
			export_csv: document.getElementById('export-csv').checked,
			
			// Advanced settings
			gpu_device: parseInt(document.getElementById('gpu-device').value),
			worker_threads: parseInt(document.getElementById('worker-threads').value),
			rate_limit: parseInt(document.getElementById('rate-limit').value),
			log_level: document.getElementById('log-level').value,
			debug_mode: document.getElementById('debug-mode').checked
		};
		
		console.debug('Collected form data:', formData);
		return formData;
	}

	exportConfig() {
		const config = this.collectFormData();
		const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = `lpr_config_${new Date().toISOString().slice(0, 10)}.json`;
		a.click();
		URL.revokeObjectURL(url);
		
		if (window.lprApp) {
			window.lprApp.showNotification('Configuration exported successfully', 'success');
		}
	}

	async resetConfig() {
		if (!confirm('Are you sure you want to reset all settings to their default values? This action cannot be undone.')) {
			return;
		}
		
		try {
			const response = await fetch('/api/system/config/reset', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			});
			
			const result = await response.json();
			
			if (response.ok) {
				this.hasChanges = false;
				
				// Reload the configuration to show defaults
				await this.loadCurrentConfig();
				
				if (window.lprApp) {
					window.lprApp.showNotification(result.message || 'Configuration reset to defaults', 'success');
				}
				
				console.log('Configuration reset successfully');
			} else {
				throw new Error(result.detail || result.message || 'Failed to reset configuration');
			}
		} catch (error) {
			console.error('Error resetting config:', error);
			if (window.lprApp) {
				window.lprApp.showNotification('Failed to reset configuration: ' + error.message, 'danger');
			}
		}
	}

	markChanged() {
		this.hasChanges = true;
	}

	confirmRestart() {
		this.showConfirmationModal({
			type: 'warning',
			title: 'Restart System',
			message: 'Are you sure you want to restart the License Plate Recognition system? This will temporarily interrupt detection services.',
			confirmText: 'Restart System',
			onConfirm: () => this.restartSystem()
		});
	}

	confirmShutdown() {
		this.showConfirmationModal({
			type: 'danger',
			title: 'Shutdown System',
			message: 'Are you sure you want to shutdown the system? This will stop all detection services and require manual restart.',
			confirmText: 'Shutdown System',
			onConfirm: () => this.shutdownSystem()
		});
	}

	showConfirmationModal({ type, title, message, confirmText, onConfirm }) {
		// Remove any existing modal
		this.removeModal();

		const modalOverlay = document.createElement('div');
		modalOverlay.className = 'modal-overlay';
		modalOverlay.id = 'confirmation-modal';

		const iconSvg = type === 'danger' 
			? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>'
			: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>';

		modalOverlay.innerHTML = `
			<div class="modal-content">
				<div class="modal-header">
					<div class="modal-icon ${type}">
						<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							${iconSvg}
						</svg>
					</div>
					<h3 class="modal-title">${title}</h3>
					<button class="modal-close" id="modal-close-btn">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="18" y1="6" x2="6" y2="18"></line>
							<line x1="6" y1="6" x2="18" y2="18"></line>
						</svg>
					</button>
				</div>
				<div class="modal-body">
					<p>${message}</p>
				</div>
				<div class="modal-actions">
					<button class="btn btn-outline" id="modal-cancel-btn">Cancel</button>
					<button class="btn btn-${type}" id="modal-confirm-btn">${confirmText}</button>
				</div>
			</div>
		`;

		// Close modal when clicking overlay
		modalOverlay.addEventListener('click', (e) => {
			if (e.target === modalOverlay) {
				this.removeModal();
			}
		});

		// Close modal on escape key
		const handleEscape = (e) => {
			if (e.key === 'Escape') {
				this.removeModal();
				document.removeEventListener('keydown', handleEscape);
			}
		};
		document.addEventListener('keydown', handleEscape);

		document.body.appendChild(modalOverlay);

		// Add event listeners after the modal is in the DOM
		const closeBtn = document.getElementById('modal-close-btn');
		const cancelBtn = document.getElementById('modal-cancel-btn');
		const confirmBtn = document.getElementById('modal-confirm-btn');

		if (closeBtn) {
			closeBtn.addEventListener('click', () => {
				this.removeModal();
			});
		}

		if (cancelBtn) {
			cancelBtn.addEventListener('click', () => {
				this.removeModal();
			});
		}

		if (confirmBtn) {
			confirmBtn.addEventListener('click', () => {
				this.removeModal();
				onConfirm();
			});
		}
	}

	removeModal() {
		// Remove all possible modal types
		const modals = [
			'confirmation-modal',
			'restart-progress',
			'shutdown-message'
		];
		
		modals.forEach(modalId => {
			const modal = document.getElementById(modalId);
			if (modal) {
				modal.remove();
			}
		});
	}

	async restartSystem() {
		try {
			const button = document.getElementById('restart-app');
			if (button) {
				button.disabled = true;
				button.innerHTML = `
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M3 7v6h6"></path>
						<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
					</svg>
					Restarting...
				`;
			}

			const response = await fetch('/api/system/restart', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					component: 'all',
					restart_type: 'graceful'
				})
			});

			const result = await response.json();

			if (response.ok) {
				if (window.lprApp) {
					window.lprApp.showNotification('System restart initiated successfully', 'success');
				}

				// Show restart progress
				this.showRestartProgress();
			} else {
				throw new Error(result.detail || result.message || 'Failed to restart system');
			}
		} catch (error) {
			console.error('Error restarting system:', error);
			if (window.lprApp) {
				window.lprApp.showNotification('Failed to restart system: ' + error.message, 'danger');
			}

			// Re-enable button on error
			const button = document.getElementById('restart-app');
			if (button) {
				button.disabled = false;
				button.innerHTML = `
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M3 7v6h6"></path>
						<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
					</svg>
					Restart System
				`;
			}
		}
	}

	async shutdownSystem() {
		try {
			const button = document.getElementById('shutdown-app');
			if (button) {
				button.disabled = true;
				button.innerHTML = `
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
						<line x1="12" y1="2" x2="12" y2="12"></line>
					</svg>
					Shutting down...
				`;
			}

			const response = await fetch('/api/system/shutdown', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					timeout: 30.0
				})
			});

			const result = await response.json();

			if (response.ok) {
				if (window.lprApp) {
					window.lprApp.showNotification('System shutdown initiated successfully', 'warning');
				}

				// Show shutdown message
				this.showShutdownMessage();
			} else {
				throw new Error(result.detail || result.message || 'Failed to shutdown system');
			}
		} catch (error) {
			console.error('Error shutting down system:', error);
			if (window.lprApp) {
				window.lprApp.showNotification('Failed to shutdown system: ' + error.message, 'danger');
			}

			// Re-enable button on error
			const button = document.getElementById('shutdown-app');
			if (button) {
				button.disabled = false;
				button.innerHTML = `
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
						<line x1="12" y1="2" x2="12" y2="12"></line>
					</svg>
					Shutdown
				`;
			}
		}
	}

	showRestartProgress() {
		const progressOverlay = document.createElement('div');
		progressOverlay.className = 'modal-overlay';
		progressOverlay.id = 'restart-progress';

		progressOverlay.innerHTML = `
			<div class="modal-content">
				<div class="modal-header">
					<div class="modal-icon warning">
						<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M3 7v6h6"></path>
							<path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
						</svg>
					</div>
					<h3 class="modal-title">System Restarting</h3>
					<button class="modal-close" id="restart-progress-close-btn">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="18" y1="6" x2="6" y2="18"></line>
							<line x1="6" y1="6" x2="18" y2="18"></line>
						</svg>
					</button>
				</div>
				<div class="modal-body">
					<p>The system is restarting. This page will automatically reload when the system is back online.</p>
					<div style="text-align: center; margin-top: 20px;">
						<div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
					</div>
				</div>
			</div>
		`;

		// Close modal when clicking overlay
		progressOverlay.addEventListener('click', (e) => {
			if (e.target === progressOverlay) {
				this.removeModal();
			}
		});

		document.body.appendChild(progressOverlay);

		// Add event listener for close button
		const closeBtn = document.getElementById('restart-progress-close-btn');
		if (closeBtn) {
			closeBtn.addEventListener('click', () => {
				this.removeModal();
			});
		}

		// Check system status and reload when ready
		this.checkSystemStatus();
	}

	showShutdownMessage() {
		const shutdownOverlay = document.createElement('div');
		shutdownOverlay.className = 'modal-overlay';
		shutdownOverlay.id = 'shutdown-message';

		shutdownOverlay.innerHTML = `
			<div class="modal-content">
				<div class="modal-header">
					<div class="modal-icon danger">
						<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
							<line x1="12" y1="2" x2="12" y2="12"></line>
						</svg>
					</div>
					<h3 class="modal-title">System Shutdown</h3>
					<button class="modal-close" id="shutdown-message-close-btn">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="18" y1="6" x2="6" y2="18"></line>
							<line x1="6" y1="6" x2="18" y2="18"></line>
						</svg>
					</button>
				</div>
				<div class="modal-body">
					<p>The system is shutting down. The application will be unavailable until manually restarted.</p>
					<p style="margin-top: 10px; font-weight: bold;">You can safely close this browser window.</p>
				</div>
			</div>
		`;

		// Close modal when clicking overlay
		shutdownOverlay.addEventListener('click', (e) => {
			if (e.target === shutdownOverlay) {
				this.removeModal();
			}
		});

		document.body.appendChild(shutdownOverlay);

		// Add event listener for close button
		const closeBtn = document.getElementById('shutdown-message-close-btn');
		if (closeBtn) {
			closeBtn.addEventListener('click', () => {
				this.removeModal();
			});
		}
	}

	async checkSystemStatus() {
		let attempts = 0;
		const maxAttempts = 60; // Try for 2 minutes
		
		const checkStatus = async () => {
			try {
				const response = await fetch('/api/system/health/detailed', {
					method: 'GET',
					timeout: 5000
				});
				
				if (response.ok) {
					// System is back online, reload the page
					window.location.reload();
				} else {
					throw new Error('System not ready');
				}
			} catch (error) {
				attempts++;
				if (attempts < maxAttempts) {
					setTimeout(checkStatus, 2000); // Check every 2 seconds
				} else {
					// Max attempts reached, show error and allow manual reload
					this.showRestartError();
				}
			}
		};

		// Start checking after a short delay
		setTimeout(checkStatus, 5000);
	}

	showRestartError() {
		const progressModal = document.getElementById('restart-progress');
		if (progressModal) {
			progressModal.innerHTML = `
				<div class="modal-content">
					<div class="modal-header">
						<div class="modal-icon danger">
							<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<circle cx="12" cy="12" r="10"></circle>
								<line x1="15" y1="9" x2="9" y2="15"></line>
								<line x1="9" y1="9" x2="15" y2="15"></line>
							</svg>
						</div>
						<h3 class="modal-title">Restart Taking Longer Than Expected</h3>
					</div>
					<div class="modal-body">
						<p>The system restart is taking longer than expected. Please wait a few more moments or try refreshing the page manually.</p>
					</div>
					<div class="modal-actions">
						<button class="btn btn-primary" onclick="window.location.reload()">Refresh Page</button>
					</div>
				</div>
			`;
		}
	}
}

// Initialize system config
const systemConfig = new SystemConfig();
{% endblock %}